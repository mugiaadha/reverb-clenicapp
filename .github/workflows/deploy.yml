name: Deploy to VPS (simple)

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_PATH: ${{ secrets.VPS_PATH }}
      VPS_PORT: ${{ secrets.VPS_PORT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Frontend build will run on the VPS after files are rsynced

      # ---------- BACKEND ----------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          tools: composer:v2

      - name: Composer install
        run: |
          composer install \
            --no-dev \
            --prefer-dist \
            --optimize-autoloader \
            --no-interaction

      # ---------- SSH ----------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${VPS_PORT:-22} -H $VPS_HOST >> ~/.ssh/known_hosts

      # ---------- RSYNC ----------
      - name: Rsync to VPS
        run: |
          rsync -az --delete \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=.env \
            -e "ssh -i ~/.ssh/deploy_key -p ${VPS_PORT:-22}" \
            ./ $VPS_USER@$VPS_HOST:$VPS_PATH

      - name: Remote npm build (on VPS)
        run: |
          ssh -i ~/.ssh/deploy_key -p ${VPS_PORT:-22} $VPS_USER@$VPS_HOST "bash -lc '
            set -e
            cd $VPS_PATH
            if command -v npm >/dev/null 2>&1; then
              npm ci
              npm run build
            else
              echo "npm not found on server; skipping frontend build"
            fi
          '"]

      # ---------- FIX PERMISSION + ARTISAN ----------
      - name: Fix permission & artisan
        run: |
          ssh -i ~/.ssh/deploy_key -p $VPS_PORT $VPS_USER@$VPS_HOST "
          set -e
          cd $VPS_PATH

          # pastikan semua folder storage & bootstrap/cache ada
          mkdir -p storage/framework/{cache,sessions,views} storage/logs bootstrap/cache database

          # fix ownership semua folder Laravel
          sudo chown -R $VPS_USER:www-data storage bootstrap/cache database

          # fix permission â†’ owner & group bisa write
          sudo chmod -R 775 storage bootstrap/cache database

          # hapus file log lama (optional, biar artisan bisa write)
          rm -f storage/logs/*.log

          # kalau pakai SQLite, pastikan file ada & writable
          touch database/database.sqlite
          sudo chown $VPS_USER:www-data database/database.sqlite
          sudo chmod 664 database/database.sqlite

          # clear cache & migrate
          php artisan migrate --force || true
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
          php artisan view:clear"
