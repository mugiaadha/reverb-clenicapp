name: Deploy to VPS (simple)

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_PATH: ${{ secrets.VPS_PATH }}
      VPS_PORT: ${{ secrets.VPS_PORT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- FRONTEND BUILD ----------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build assets
        run: |
          npm ci
          npm run build

      # ---------- BACKEND ----------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          tools: composer:v2

      - name: Composer install
        run: |
          composer install \
            --no-dev \
            --prefer-dist \
            --optimize-autoloader \
            --no-interaction

      # ---------- SSH ----------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${VPS_PORT:-22} -H $VPS_HOST >> ~/.ssh/known_hosts

      # ---------- RSYNC ----------
      - name: Rsync to VPS
        run: |
          rsync -az --delete \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=.env \
            -e "ssh -i ~/.ssh/deploy_key -p ${VPS_PORT:-22}" \
            ./ $VPS_USER@$VPS_HOST:$VPS_PATH

      # ---------- FIX PERMISSION + ARTISAN ----------
      - name: Fix permission & artisan
        run: |
          ssh -i ~/.ssh/deploy_key -p ${VPS_PORT:-22} $VPS_USER@$VPS_HOST "
            set -e
            cd $VPS_PATH

            # pastikan semua folder ada
            mkdir -p storage/framework/{cache,sessions,views} bootstrap/cache

            # ownership aman: user deploy + group www-data
            sudo chown -R $VPS_USER:www-data storage bootstrap/cache

            # permission 775 â†’ owner & group bisa write
            sudo chown -R ***:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            sudo chmod -R 775 storage/framework/views


            # migrate + clear cache
            php artisan migrate --force || true
            php artisan config:clear
            php artisan cache:clear
            php artisan config:cache
            php artisan view:clear
          "
      - name: Debug permissions
        run: |
          ssh -i ~/.ssh/deploy_key -p ${VPS_PORT:-22} $VPS_USER@$VPS_HOST "
            cd $VPS_PATH
            whoami
            ls -lah storage/framework
            ls -lah storage/framework/views
            ls -lah bootstrap/cache
          "
