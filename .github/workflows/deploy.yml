name: Deploy to VPS (simple)

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_PATH: ${{ secrets.VPS_PATH }}
      VPS_PORT: ${{ secrets.VPS_PORT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Frontend build will run on the VPS after files are rsynced

      # ---------- BACKEND ----------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          tools: composer:v2

      - name: Composer install
        run: |
          composer install \
            --no-dev \
            --prefer-dist \
            --optimize-autoloader \
            --no-interaction

      # ---------- SSH ----------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${VPS_PORT:-22} -H $VPS_HOST >> ~/.ssh/known_hosts

      # ---------- RSYNC ----------
      - name: Rsync to VPS
        run: |
          # run rsync with verbose output and progress so logs show transferred files
          rsync -avz --progress --stats --delete \
          --exclude=.git \
          --exclude=node_modules \
          --exclude=.env \
          -e "ssh -i ~/.ssh/deploy_key -p ${VPS_PORT:-22}" \
          ./ $VPS_USER@$VPS_HOST:$VPS_PATH

      - name: Remote npm build (on VPS)
        run: |
          ssh -i ~/.ssh/deploy_key -p ${VPS_PORT:-22} $VPS_USER@$VPS_HOST <<'REMOTE'
          set -e
          cd "$VPS_PATH"
          if command -v npm >/dev/null 2>&1; then
            # Prefer clean, reproducible installs when a lockfile exists
            if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
              echo "Found lockfile -> running 'npm ci'"
              npm ci
            else
              echo "No lockfile found -> running 'npm install' (this will generate a lockfile)"
              npm install
            fi
            npm run build
          else
            echo "npm not found on server; skipping frontend build"
          fi
          REMOTE

      # ---------- FIX PERMISSION + ARTISAN ----------
      - name: Fix permission & artisan
        run: |
          ssh -i ~/.ssh/deploy_key -p ${VPS_PORT:-22} $VPS_USER@$VPS_HOST <<'REMOTE'
          set -e
          cd "$VPS_PATH"

          # ensure storage & bootstrap/cache directories exist
          mkdir -p storage/framework/{cache,sessions,views} storage/logs bootstrap/cache database

          # fix ownership for web user (use sudo only if available)
          if command -v sudo >/dev/null 2>&1; then
            sudo chown -R $VPS_USER:www-data storage bootstrap/cache database || true
            sudo chmod -R 775 storage bootstrap/cache database || true
          else
            chown -R $VPS_USER:www-data storage bootstrap/cache database || true
            chmod -R 775 storage bootstrap/cache database || true
          fi

          # remove old logs
          rm -f storage/logs/*.log || true

          # ensure sqlite file exists and is writable (if used)
          touch database/database.sqlite || true
          if command -v sudo >/dev/null 2>&1; then
            sudo chown $VPS_USER:www-data database/database.sqlite || true
            sudo chmod 664 database/database.sqlite || true
          else
            chown $VPS_USER:www-data database/database.sqlite || true
            chmod 664 database/database.sqlite || true
          fi

          # run migrations and clear caches
          php artisan migrate --force || true
          php artisan config:clear || true
          php artisan cache:clear || true
          php artisan config:cache || true
          php artisan view:clear || true
          REMOTE
