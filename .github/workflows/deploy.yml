name: Deploy to VPS

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            - name: Install dependencies and build assets
              run: |
                  npm ci
                  npm run build

            - name: Setup PHP and Composer (for CI build)
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.2"
                  extensions: mbstring,xml,zip,curl,pdo_mysql
                  tools: composer:v2

            - name: Install PHP dependencies (composer)
              run: |
                  composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

            - name: Setup SSH key (use runner ssh-agent)
              shell: bash
              run: |
                  set -euo pipefail
                  mkdir -p ~/.ssh
                  echo "Setting up SSH key from secret"
                  if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
                    echo "SSH_PRIVATE_KEY secret is empty" >&2
                    exit 1
                  fi
                  # write private key to file and secure it
                  printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
                  chmod 600 ~/.ssh/deploy_key

            - name: Add VPS to known_hosts
              run: |
                  mkdir -p ~/.ssh
                  # ensure VPS_HOST is set
                  if [ -z "${{ secrets.VPS_HOST }}" ]; then
                    echo "VPS_HOST secret is empty" >&2
                    exit 1
                  fi
                  # If VPS_PORT is empty or 22, use default (no -p). If non-empty, include -p.
                  if [ -z "${{ secrets.VPS_PORT }}" ] || [ "${{ secrets.VPS_PORT }}" = "22" ]; then
                    ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts || echo "ssh-keyscan failed (host unreachable), continuing"
                  else
                    ssh-keyscan -p "${{ secrets.VPS_PORT }}" -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts || echo "ssh-keyscan failed (host unreachable), continuing"
                  fi

            - name: Rsync project to VPS
              run: |
                  set -euo pipefail
                  # validate required secrets
                  if [ -z "${{ secrets.VPS_USER }}" ] || [ -z "${{ secrets.VPS_HOST }}" ] || [ -z "${{ secrets.VPS_PATH }}" ]; then
                    echo "One or more of VPS_USER / VPS_HOST / VPS_PATH secrets is empty" >&2
                    echo "Please set these repository secrets in Settings -> Secrets" >&2
                    exit 1
                  fi
                  # build RSYNC_RSH depending on port
                  if [ -z "${{ secrets.VPS_PORT }}" ] || [ "${{ secrets.VPS_PORT }}" = "22" ]; then
                    export RSYNC_RSH="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no"
                  else
                    export RSYNC_RSH="ssh -i ~/.ssh/deploy_key -p ${{ secrets.VPS_PORT }} -o StrictHostKeyChecking=no"
                  fi
                  DEST="${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_PATH }}"
                  echo "Deploy destination: $DEST"
                  rsync -avz --delete \
                    --exclude '.git' \
                    --exclude 'node_modules' \
                    --exclude '.env' \
                    --exclude 'storage/*.key' \
                    --exclude 'storage/app/private' \
                    --exclude 'storage/framework' \
                    --exclude 'storage/logs' \
                    --exclude 'tests' \
                    ./ "$DEST"

            - name: Run remote artisan tasks
              run: |
                  ssh -i ~/.ssh/deploy_key -p "${{ secrets.VPS_PORT }}" "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
                     "cd '${{ secrets.VPS_PATH }}' && \
                     php artisan migrate --force || true && \
                     php artisan config:cache || true && \
                     php artisan route:cache || true && \
                     php artisan view:cache || true && \
                     php artisan queue:restart || true"
